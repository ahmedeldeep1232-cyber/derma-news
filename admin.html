<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - لوحة تحكم الأخبار</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    .admin-wrap{max-width:900px;margin:20px auto;background:#fff;padding:18px;border-radius:10px}
    label{display:block;margin-top:10px}
    input,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .btn{display:inline-block;padding:8px 14px;background:#0a6ebd;color:#fff;border-radius:8px;border:none;cursor:pointer;margin-top:10px}
    .btn-danger{background:#d64545}
    .post-list{margin-top:20px}
    .post-item{padding:10px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
<div class="admin-wrap">
  <h2>لوحة تحكم الأخبار</h2>

  <div id="auth-area">
    <p>تسجيل دخول لإدارة الأخبار</p>
    <label>البريد الإلكترونى</label>
    <input id="email" type="email" placeholder="email@example.com">
    <label>كلمة السر</label>
    <input id="password" type="password" placeholder="••••••">
    <button id="loginBtn" class="btn">دخول</button>
    <button id="logoutBtn" class="btn" style="display:none">خروج</button>
    <p style="color:#666;margin-top:8px">لو لسه ما عندكش حساب: سجّل أول مرة من نفس النموذج وسيتم إنشاء المستخدم.</p>
  </div>

  <hr>

  <div id="editor" style="display:none">
    <h3>أضف/عدّل خبر</h3>
    <label>العنوان</label>
    <input id="title">
    <div class="row">
      <div>
        <label>التاريخ</label>
        <input id="date" type="date">
      </div>
      <div>
        <label>صورة (رفع)</label>
        <input id="imageFile" type="file" accept="image/*">
      </div>
    </div>
    <label>النص</label>
    <textarea id="content" rows="6"></textarea>
    <button id="saveBtn" class="btn">نشر / حفظ</button>

    <h3 style="margin-top:20px">الأخبار الموجودة</h3>
    <div id="postsList" class="post-list"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script src="../config.js"></script>

<script>
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const postsRef = db.ref('posts');

  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const editor = document.getElementById('editor');
  const authArea = document.getElementById('auth-area');

  loginBtn.addEventListener('click', async ()=>{
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email||!pass){ alert('ادخل ايميل و كلمة سر'); return; }
    try{
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){
      // if not exist, create account
      try{ await auth.createUserWithEmailAndPassword(email, pass); }
      catch(err){ alert('خطأ في الدخول: '+err.message); return; }
    }
  });

  logoutBtn.addEventListener('click', ()=> auth.signOut());

  auth.onAuthStateChanged(user=>{
    if(user){
      authArea.style.display='none';
      editor.style.display='block';
      logoutBtn.style.display='inline-block';
      loadPostsList();
    } else {
      authArea.style.display='block';
      editor.style.display='none';
      logoutBtn.style.display='none';
    }
  });

  async function uploadImage(file){
    const path = 'uploads/'+Date.now()+'_'+file.name;
    const snap = await storage.ref(path).put(file);
    const url = await snap.ref.getDownloadURL();
    return url;
  }

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    const title = document.getElementById('title').value.trim();
    const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
    const content = document.getElementById('content').value.trim();
    const fileInput = document.getElementById('imageFile');
    if(!title||!content){ alert('العنوان والنص مطلوبين'); return; }
    let imageUrl = '';
    if(fileInput.files.length){
      imageUrl = await uploadImage(fileInput.files[0]);
    }
    const newPostRef = postsRef.push();
    await newPostRef.set({ title, date, content, image: imageUrl });
    alert('تم النشر');
    document.getElementById('title').value=''; document.getElementById('content').value=''; fileInput.value='';
    loadPostsList();
  });

  function loadPostsList(){
    const list = document.getElementById('postsList');
    list.innerHTML = 'جارٍ التحميل...';
    postsRef.once('value').then(snap=>{
      const data = snap.val() || {};
      list.innerHTML = '';
      Object.keys(data).forEach(key=>{
        const p = data[key];
        const div = document.createElement('div');
        div.className = 'post-item';
        const left = document.createElement('div');
        left.innerHTML = '<strong>'+p.title+'</strong><br><small>'+p.date+'</small>';
        const right = document.createElement('div');
        const editBtn = document.createElement('button'); editBtn.textContent='حذف'; editBtn.className='btn btn-danger';
        editBtn.onclick = ()=> {
          if(confirm('مسح الخبر؟')) postsRef.child(key).remove().then(()=>loadPostsList());
        };
        right.appendChild(editBtn);
        div.appendChild(left); div.appendChild(right);
        list.appendChild(div);
      });
    });
  }
</script>
</body>
</html>
